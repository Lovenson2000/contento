name: Expo PR Build Check

on:
  pull_request:
    branches: [main]

jobs:
  build:
    name: ğŸ§± Verify App Build (Android & iOS)
    runs-on: ubuntu-latest

    steps:
      # ----------------------------
      # ğŸ§© Step 1: Checkout repository
      # ----------------------------
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      # ----------------------------
      # âš™ï¸ Step 2: Setup Node.js with cache
      # ----------------------------
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      # ----------------------------
      # ğŸ’¾ Step 3: Cache Gradle
      # ----------------------------
      - name: ğŸ’¾ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # ----------------------------
      # ğŸ“¦ Step 4: Install dependencies
      # ----------------------------
      - name: ğŸ“¦ Install dependencies
        run: |
          npm install -g eas-cli
          npm ci

      # ----------------------------
      # ğŸ§ª Step 5: Lint check
      # ----------------------------
      - name: ğŸ§ª Lint Check
        run: npm run lint

      # ----------------------------
      # ğŸ” Step 6: Authenticate with Expo
      # ----------------------------
      - name: ğŸ” Authenticate with Expo
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_ACCESS_TOKEN }}
        run: |
          echo "ğŸ”‘ Authenticating with Expo..."
          npx eas whoami || echo "Expo token authentication complete âœ…"

      # ----------------------------
      # ğŸ§± Step 7: Verify Expo Prebuild
      # ----------------------------
      - name: ğŸ§± Verify Expo Prebuild
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_ACCESS_TOKEN }}
        run: |
          echo "âš™ï¸ Running Expo prebuild check..."
          npx expo prebuild --non-interactive --no-install

      # ----------------------------
      # âœ… Step 8: Android build
      # ----------------------------
      - name: Android Build
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_ACCESS_TOKEN }}
        run: |
          echo "ğŸ“± Performing Android build..."
          npx eas build --platform android --non-interactive --skip-credentials-check

      # ----------------------------
      # âœ… Step 9: iOS build
      # ----------------------------
      - name: iOS Build
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_ACCESS_TOKEN }}
        run: |
          echo "ğŸ Performing iOS build..."
          npx eas build --platform ios --non-interactive --skip-credentials-check
