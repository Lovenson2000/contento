name: Expo PR Build Check

on:
  pull_request:
    branches: [main]

jobs:
  build:
    name: ğŸ§± Verify App Build (Android & iOS)
    runs-on: ubuntu-latest

    steps:
      # ----------------------------
      # ğŸ§© Step 1: Checkout repository
      # ----------------------------
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      # ----------------------------
      # âš™ï¸ Step 2: Setup Node.js
      # ----------------------------
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      # ----------------------------
      # ğŸ’¾ Step 3: Cache Gradle (for faster dry-run)
      # ----------------------------
      - name: ğŸ’¾ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # ----------------------------
      # ğŸ“¦ Step 4: Install dependencies
      # ----------------------------
      - name: ğŸ“¦ Install dependencies
        run: |
          npm install -g eas-cli
          npm ci

      # ----------------------------
      # ğŸ§ª Step 5: Lint check
      # ----------------------------
      - name: ğŸ§ª Lint Check
        run: npm run lint

      # ----------------------------
      # ğŸ” Step 6: Authenticate with Expo
      # ----------------------------
      - name: ğŸ” Authenticate with Expo
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_ACCESS_TOKEN }}
        run: |
          echo "ğŸ”‘ Authenticating with Expo using token..."
          npx eas whoami || npx eas login --non-interactive

      # ----------------------------
      # ğŸ§± Step 7: Verify project setup
      # ----------------------------
      - name: ğŸ§± Verify Expo Prebuild
        run: |
          echo "âš™ï¸ Running Expo prebuild check..."
          npx expo prebuild --non-interactive --no-install

      # ----------------------------
      # ğŸ“‹ Step 8: Check EAS config validity
      # ----------------------------
      - name: ğŸ“‹ Check EAS build configuration
        run: |
          echo "ğŸ§° Validating EAS configuration..."
          npx eas build:configure

      # ----------------------------
      # âœ… Step 9: Android dry-run build
      # ----------------------------
      - name: âœ… Android Build (Dry Run)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_ACCESS_TOKEN }}
        run: |
          echo "ğŸ“± Performing Android dry-run build..."
          npx eas build --platform android --non-interactive --skip-credentials-check --dry-run

      # ----------------------------
      # âœ… Step 10: iOS dry-run build
      # ----------------------------
      - name: âœ… iOS Build (Dry Run)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_ACCESS_TOKEN }}
        run: |
          echo "ğŸ Performing iOS dry-run build..."
          npx eas build --platform ios --non-interactive --skip-credentials-check --dry-run
